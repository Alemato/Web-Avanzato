<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/dt-1.10.20/datatables.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css"/>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
          integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <style>
        .imgProfilo {
            height: 150px;
            width: 150px;
        }

        .imgChat {
            height: 50px;
            width: 50px;
        }

        .loading-centrato {
            margin-top: 50px;
            text-align: center;
        }

        .centrato {
            text-align: center;
        }

        .mt-50 {
            margin-top: 50px;
        }

        .riga-divisoria {
            border: rgba(82, 82, 82, 0.41) 1px solid;
            margin-bottom: 25px;
            margin-top: 25px;
        }

        .riga {
            border: rgba(189, 183, 193, 0.2) 1px solid;
            margin-bottom: 25px;
            margin-top: 25px;
        }

        .fs-150 {
            font-size: 150px;
        }
    </style>
    <script type="text/javascript"
            src="https://cdn.datatables.net/v/bs4/jq-3.3.1/dt-1.10.20/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
</head>
<body>
<div id="login-wrap" class="row px-2">
    <div class="col">
        <label for="email">Inserisci email</label><input id="email" type="email">
    </div>
    <div class="col">
        <label for="password">Inserisci password</label><input id="password" type="password">
    </div>
    <div class="col align-self-center">
        <button id="login" class="btn btn-info btn-block">Login</button>
    </div>
</div>
<script>
    $(document).ready(function () {
        let XAuth = '';
        let user = {};
        let $loginWrap;
        let $login = $("#login");

        let chats = [];
        let message = [];
        let $divTableMess = $("#divWrapTableMessage");
        let $rigaDivMex = $("#rigaDiv");
        let $divTable = $("#divWrapTableChat");
        let $rigaDivChat = $("#rigaDivChat");
        let $rigaDivNewMex = $("#riga-div-new-mex");
        let $divWrapNewMessage = $("#div-wrap-new-message");


        $login.click(function () {
            runLogin();
        });

        function profiloStudentPresentation(data) {
            const ruoles = "Studente";
            let studyGrade = "Non disponibile";
            let dataNascita = new Date(data.birthday).toLocaleDateString();
            $loginWrap.after("<div id='profilo-wrap' style='display: none;'></div>");
            let $profilowrap = $("#profilo-wrap");

            $profilowrap.append("<div class='riga'></div><div class='row'></div>");
            let $profilowrapRow = $("#profilo-wrap div.row");

            $profilowrapRow.append("<div class='col-auto align-self-center pl-3'></div>");
            let $profilowrapRowColAutoAlign = $("#profilo-wrap div.row div.col-auto.align-self-center");

            if (data.image !== null && data.image !== undefined && data.image !== ' ') {
                $profilowrapRowColAutoAlign.append("<img class='imgProfilo rounded-circle' src=\"" + data.image + "\" alt='img profilo'>");
            } else {
                $profilowrapRowColAutoAlign.append("<i class='fas fa-user-circle text-primary fs-150'></i>")
            }
            $profilowrapRow.append("<div class='col-auto row pr-5'></div>");
            if (data.studyGrade !== null && data.studyGrade !== undefined) {
                studyGrade = data.studyGrade;
            }
            let $profilowarpRowColAutoRowPr5 = $("#profilo-wrap div.row div.col-auto.row.pr-5");

            $profilowarpRowColAutoRowPr5.append("<div class='col-auto'><h3>" + data.name + " " + data.surname + "</h3><h3>" + ruoles + "</h3><h3>Nato il:</h3></div>");
            $profilowarpRowColAutoRowPr5.append("<div class='col-auto'><h3>" + data.email + "</h3><h3>" + studyGrade + "</h3><h3>" + dataNascita + "</h3></div>")
            $profilowrap.after("<div class='riga'></div><div id='bottoni-profilo' class='row px-2' style='display: none;'></div>");
            let $bottoniProfilo = $("#bottoni-profilo");

            $bottoniProfilo.append("<div class='col'><button id='moficaUtente' class='btn btn-info btn-block'>Modifica Utente</button></div>" +
                "<div class='col'><button id='listaChat' class='btn btn-success btn-block'>Visualizza chat disponibili</button>\n" +
                "</div><div class='col'><button id='logOut' class='btn btn-danger btn-block'>Logout</button></div>");

            $("#listaChat").click(function () {
                $divTableMess.fadeOut();
                $rigaDivMex.fadeOut();
                $divTable.fadeOut();
                $rigaDivChat.fadeOut();
                $divWrapNewMessage.fadeOut();
                $rigaDivNewMex.fadeOut();
                takeChats()
            });

            $("#logOut").click(function () {
                logOut();
            });

            $loginWrap.fadeOut();
            $profilowrap.fadeIn();
            $bottoniProfilo.fadeIn();
        }

        function profiloTeacherPresentation(data) {
            const ruoles = "Teacher";
            let byography = "Non disponibile";
            let dataNascitaT = new Date(data.birthday).toLocaleDateString();
            $loginWrap.after("<div id='profilo-wrap' style='display: none;'></div>");
            let $profilowrap = $("#profilo-wrap");

            $profilowrap.append("<div class='riga'></div><div class='row'></div>");
            let $profilowrapRow = $("#profilo-wrap div.row");

            $profilowrapRow.append("<div class='col-auto align-self-center pl-3'></div>");
            let $profilowrapRowColAutoAlign = $("#profilo-wrap div.row div.col-auto.align-self-center");

            if (data.image !== null && data.image !== undefined && data.image !== ' ') {
                $profilowrapRowColAutoAlign.append("<img class='imgProfilo rounded-circle' src=\"" + data.image + "\" alt='img profilo'>");
            } else {
                $profilowrapRowColAutoAlign.append("<i class='fas fa-user-circle text-primary fs-150'></i>")
            }
            $profilowrapRow.append("<div class='col-auto row pr-5'></div>");
            if (data.byography !== null && data.byography !== undefined) {
                byography = data.byography;
            }
            let $profilowarpRowColAutoRowPr5 = $("#profilo-wrap div.row div.col-auto.row.pr-5");

            $profilowarpRowColAutoRowPr5.append("<div class='col-auto'><h3>" + data.name + " " + data.surname + "</h3><h3>" + ruoles + "</h3><h3>Nato il:</h3></div>");
            $profilowarpRowColAutoRowPr5.append("<div class='col-auto'><h3>" + data.email + "</h3><h3>&nbsp;</h3><h3>" + dataNascitaT + "</h3></div>");
            $profilowrap.after("<div class='riga'></div><div id='bottoni-profilo' class='row px-2' style='display: none;'></div>");
            let $bottoniProfilo = $("#bottoni-profilo");

            $bottoniProfilo.append("<div class='col'><button id='moficaUtente' class='btn btn-info btn-block'>Modifica Utente</button></div>" +
                "<div class='col'><button id='listaChat' class='btn btn-success btn-block'>Visualizza chat disponibili</button>\n" +
                "</div><div class='col'><button id='logOut' class='btn btn-danger btn-block'>Logout</button></div>");

            $("#listaChat").click(function () {
                $divTableMess.fadeOut();
                $rigaDivMex.fadeOut();
                $divTable.fadeOut();
                $rigaDivChat.fadeOut();
                $divWrapNewMessage.fadeOut();
                $rigaDivNewMex.fadeOut();
                takeChats()
            });

            $("#logOut").click(function () {
                logOut();
            });

            $loginWrap.fadeOut();
            $profilowrap.fadeIn();
            $bottoniProfilo.fadeIn();
        }

        async function login(email, password) {
            await $.ajax({
                contentType: "application/json",
                dataType: "json",
                url: "http://localhost:8080/api/auth",
                method: "POST",
                data: JSON.stringify({
                    "username": email,
                    "password": password
                }),
                success: function (data, textStatus, request) {
                    console.log(data);
                    console.log(textStatus);
                    console.log(request.getAllResponseHeaders());
                    user = data;
                    XAuth = request.getResponseHeader("X-Auth");
                    console.log(XAuth);
                },
            });
        }

        function runLogin() {
            const email = $("#email").val();
            const passowd = $("#password").val();
            console.log(email);
            console.log(passowd);
            if (email !== null && email !== undefined && email !== " " && email !== "" && passowd !== null && passowd !== undefined && passowd !== " " && passowd !== "") {
                login(email, passowd).then(() => {
                    $("input").val("");
                    $loginWrap = $("#login-wrap");
                    if (user.roles === 1) {
                        profiloStudentPresentation(user);
                    } else {
                        profiloTeacherPresentation(user);
                    }
                });
            }
        }

        async function logOut() {
            console.log("cliccato");
            user = {};
            XAuth = "";
            await $("body").children().fadeOut();
            $("body").children().remove();
            $("body").append($loginWrap);
            $loginWrap.fadeIn();
            $login.click(function () {
                runLogin();
            });
        }

        function datatableChat() {
            let $bottoniProfilo = $("#bottoni-profilo");
            $bottoniProfilo.after("<div id='rigaDivChat' class='riga-divisoria'></div><div id='divWrapTableChat' class='mt-50'></div>");
            $divTable = $("#divWrapTableChat");
            $rigaDivChat = $("#rigaDivChat");
            $divTable.append("<h4 class='text-center'>Lista Chat</h4>");
            $divTable.append("<table id=\"chat\" class=\"cell-border\" style=\"width:100%\"></table>");
            let $table = $("#chat");
            $table.append("<thead>\n" +
                "        <tr>\n" +
                "            <th>Immagine Utente</th>\n" +
                "            <th>Nome Utente</th>\n" +
                "            <th>Cognome Utente</th>\n" +
                "            <th>Ultimo Messaggio</th>\n" +
                "            <th>Data Invio</th>\n" +
                "        </tr>\n" +
                "        </thead>");
            $table.after("<tbody></tbody>");
            $divTable.append("<div class='riga'></div><div id='bottoni-chiudiChat'></div>");
            let $bottoniChiudiChat = $("#bottoni-chiudiChat");
            $bottoniChiudiChat.append("<div id='divChiudiChat' class='col'><button id='chiudiChat' class='btn btn-danger btn-block'>ChiudiChat</button></div>");
            $('#chat').on('click', 'tr', function () {
                console.log("chat cliccata");
                console.log(this.id);
                $divTableMess.fadeOut();
                $rigaDivMex.fadeOut();
                $divWrapNewMessage.fadeOut();
                $rigaDivNewMex.fadeOut();
                takeMessages(this.id);
            });

            $("#chiudiChat").click(function () {
                $divTable.fadeOut();
                $rigaDivChat.fadeOut();
                $divTableMess.fadeOut();
                $rigaDivMex.fadeOut();
                $divWrapNewMessage.fadeOut();
                $rigaDivNewMex.fadeOut();
            });
        }

        function datatableMessage(idChat, data) {
            let divWrapTableChat = $("#divWrapTableChat");
            divWrapTableChat.after("<div id='rigaDivMex' class='riga-divisoria'></div><div id='divWrapTableMessage' class='mt-50'></div>");
            $divTableMess = $("#divWrapTableMessage");
            $rigaDivMex = $("#rigaDivMex");
            $divTableMess.append("<h4 class='text-center'>Lista Messaggi</h4>");
            $divTableMess.append("<table id=\"message\" class=\"cell-border\" style=\"width:100%\"></table>");
            let $tableMess = $("#message");
            $tableMess.append("<thead>\n" +
                "        <tr>\n" +
                "            <th>Immagine Utente</th>\n" +
                "            <th>Nome Utente</th>\n" +
                "            <th>Cognome Utente</th>\n" +
                "            <th>Ultimo Messaggio</th>\n" +
                "            <th>Data Invio</th>\n" +
                "        </tr>\n" +
                "        </thead>");
            $tableMess.after("<tbody></tbody>");
            $divTableMess.append("<div class='riga'></div><div class='row' id='bottoni-message'></div>");
            let $bottoniMessage = $("#bottoni-message");
            $bottoniMessage.append("<div class='col'><button id='newMessage' class='btn btn-info btn-block'>Nuovo Messaggio</button></div>" +
                "<div id='divchiudiMessage' class='col'><button id='chiudiMessage' class='btn btn-danger btn-block'>Chiudi Messaggi</button></div>");
            $divTableMess.fadeIn();

            $("#chiudiMessage").click(function () {
                $divTableMess.fadeOut();
                $rigaDivMex.fadeOut();
                $divWrapNewMessage.fadeOut();
                $rigaDivNewMex.fadeOut();
            });

            $("#newMessage").click(function () {
                $divWrapNewMessage.fadeOut();
                $rigaDivNewMex.fadeOut();
                writeNewMessage(idChat, data);
            });
        }

        async function storeMessage(value, idChat, dato) {
            const headerParams = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJmNjcyMTFiZi0wODgyLTQ5ODYtOGNhNC04NThhMDcxOGNkZjQiLCJpc3MiOiJodHRwOi8vZXhhbXBsZS5vcmciLCJhdWQiOiJodHRwOi8vZXhhbXBsZS5vcmciLCJzdWIiOiJzdHVkZW50QHByb3ZhLml0IiwiaWF0IjoxNTgwNDcyNTA2LCJleHAiOjE2MTIwMDg1MDYsImF1dGhvcml0aWVzIjpbIlNUVURFTlQiXSwicmVmcmVzaENvdW50IjowLCJyZWZyZXNoTGltaXQiOjEsIm5hbWUiOiJBbGRvIiwic3VybmFtZSI6Ik1hcmNoZXR0aSJ9.YzZeFk7BMvZQr5TIxiP7dQ522mRaA7hxzeHmfWIkSZo'};
            const message = dato[0];
            message.idMessage = 0;
            message.text = value;
            message.sendDate = new Date().getTime();
            message.user = user;
            console.log(message);
            await $.ajax({
                headers: headerParams,
                contentType: "application/json",
                accept: "application/json",
                url: "http://localhost:8080/api/chats/" + idChat + "/messages",
                method: "POST",
                data: JSON.stringify(message),
                success: function (data, textStatus, request) {
                    console.log(data);
                    console.log(textStatus);
                    console.log(request.getAllResponseHeaders());
                }
            });
        }

        function writeNewMessage(idChat, data) {
            let $divWrapTableMessage = $("#divWrapTableMessage");
            $divWrapTableMessage.after("<div id='riga-div-new-mex' class='riga-divisoria'></div><div id='div-wrap-new-message' class='mt-50'></div>");
            $rigaDivNewMex = $("#riga-div-new-mex");
            $divWrapNewMessage = $("#div-wrap-new-message");
            $divWrapNewMessage.append("<h4 class='text-center'>Nuovo Messaggio</h4>");
            $divWrapNewMessage.append("<div id='div-wrap-textarea' ><textarea id='textarea-new-message' style='width: 95%; margin-left: 30px' rows=\"2\" cols=\"60\" placeholder='Scrivi un nuovo messaggio'></textarea></div>");
            let $divWrapTextarea = $("#div-wrap-textarea");
            $divWrapTextarea.after("<div class='riga'></div><div class='row' id='bottoni-new-message'></div>");
            let $bottoniNewMessage = $("#bottoni-new-message");
            $bottoniNewMessage.append("<div class='col'><button id='new-message' class='btn btn-info btn-block'>Invia</button></div>" +
                "<div id='div-chiudi-new-message' class='col'><button id='chiudi-new-message' class='btn btn-danger btn-block'>Chiudi</button></div>");

            $("#chiudi-new-message").click(function () {
                $divWrapNewMessage.fadeOut();
                $rigaDivNewMex.fadeOut();
            });
            $("#new-message").click(function () {
                const testo = $("#textarea-new-message").val();
                if (testo !== null && testo !== undefined && testo !== "" && testo !== " ") {
                    storeMessage(testo, idChat, data);
                    console.log(testo);
                    $divWrapNewMessage.fadeOut();
                    $rigaDivNewMex.fadeOut();
                }
            });
        }

        async function takeChats() {
            $('<div id="loadingChat" class="loading loading-centrato">Loading...</div>').appendTo('body');
            chats = [];
            message = [];
            console.log('prendo le chat');
            const headerParams = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJmNjcyMTFiZi0wODgyLTQ5ODYtOGNhNC04NThhMDcxOGNkZjQiLCJpc3MiOiJodHRwOi8vZXhhbXBsZS5vcmciLCJhdWQiOiJodHRwOi8vZXhhbXBsZS5vcmciLCJzdWIiOiJzdHVkZW50QHByb3ZhLml0IiwiaWF0IjoxNTgwNDcyNTA2LCJleHAiOjE2MTIwMDg1MDYsImF1dGhvcml0aWVzIjpbIlNUVURFTlQiXSwicmVmcmVzaENvdW50IjowLCJyZWZyZXNoTGltaXQiOjEsIm5hbWUiOiJBbGRvIiwic3VybmFtZSI6Ik1hcmNoZXR0aSJ9.YzZeFk7BMvZQr5TIxiP7dQ522mRaA7hxzeHmfWIkSZo'};
            await $.ajax({
                headers: headerParams,
                contentType: "application/json",
                accept: "application/json",
                url: "http://localhost:8080/api/chats",
                method: "GET",
                success: function (data, textStatus, request) {
                    console.log(data);
                    console.log(textStatus);
                    console.log(request.getAllResponseHeaders());
                    data.forEach((c) => {
                        console.log(c.chat.userListser[0].name);
                        if (user.roles === 1) {
                            chats.push({
                                "name": c.chat.userListser[1].name,
                                "surname": c.chat.userListser[1].surname,
                                "text": "<textarea rows=\"2\" cols=\"60\" readonly>" + c.text + "</textarea>",
                                "sendDate": new Date(c.sendDate).toLocaleString(),
                                "image": "<img class='imgChat' src=\"" + c.chat.userListser[1].image + "\" alt='img chat'>",
                                "idChat": c.chat.idChat
                            });
                        } else {
                            chats.push({
                                "name": c.chat.userListser[0].name,
                                "surname": c.chat.userListser[0].surname,
                                "text": "<textarea rows=\"2\" cols=\"60\" readonly>" + c.text + "</textarea>",
                                "sendDate": new Date(c.sendDate).toLocaleString(),
                                "image": "<img class='imgChat' src=\"" + c.chat.userListser[0].image + "\" alt='img chat'>",
                                "idChat": c.chat.idChat
                            });
                        }
                    });
                    datatableChat();
                    $("#chat").DataTable({
                        "initComplete": function () {
                            $('#loadingChat').remove();
                        },
                        "data": chats,
                        "rowId": "idChat",
                        "columns": [
                            {"data": "image", "className": "centrato"},
                            {"data": "name", "className": "centrato"},
                            {"data": "surname", "className": "centrato"},
                            {"data": "text", "className": "centrato"},
                            {"data": "sendDate", "className": "centrato"}
                        ]
                    });
                }
            });
        }

        async function takeMessages(idChat) {
            $('<div id="loadingMessage" class="loading loading-centrato">Loading...</div>').appendTo('body');
            message = [];
            console.log('prendo i messaggi');
            const headerParams = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJmNjcyMTFiZi0wODgyLTQ5ODYtOGNhNC04NThhMDcxOGNkZjQiLCJpc3MiOiJodHRwOi8vZXhhbXBsZS5vcmciLCJhdWQiOiJodHRwOi8vZXhhbXBsZS5vcmciLCJzdWIiOiJzdHVkZW50QHByb3ZhLml0IiwiaWF0IjoxNTgwNDcyNTA2LCJleHAiOjE2MTIwMDg1MDYsImF1dGhvcml0aWVzIjpbIlNUVURFTlQiXSwicmVmcmVzaENvdW50IjowLCJyZWZyZXNoTGltaXQiOjEsIm5hbWUiOiJBbGRvIiwic3VybmFtZSI6Ik1hcmNoZXR0aSJ9.YzZeFk7BMvZQr5TIxiP7dQ522mRaA7hxzeHmfWIkSZo'};
            await $.ajax({
                headers: headerParams,
                contentType: "application/json",
                accept: "application/json",
                url: "http://localhost:8080/api/chats/" + idChat + "/messages",
                method: "GET",
                success: function (data, textStatus, request) {
                    console.log(data);
                    console.log(textStatus);
                    console.log(request.getAllResponseHeaders());
                    data.forEach((m) => {
                        console.log(m.user.name);
                        message.push({
                            "name": m.user.name,
                            "surname": m.user.surname,
                            "text": "<textarea rows=\"3\" cols=\"60\" readonly>" + m.text + "</textarea>",
                            "sendDate": new Date(m.sendDate).toLocaleString(),
                            "image": "<img class='imgChat' src=\"" + m.user.image + "\" alt='img chat'>"
                        });
                    });
                    message.reverse();
                    datatableMessage(idChat, data);
                    $("#message").DataTable({
                        "initComplete": function () {
                            $('#loadingMessage').remove();
                        },
                        "data": message,
                        "columns": [
                            {"data": "image", "className": "centrato"},
                            {"data": "name", "className": "centrato"},
                            {"data": "surname", "className": "centrato"},
                            {"data": "text", "className": "centrato"},
                            {"data": "sendDate", "className": "centrato"}
                        ]
                    });

                }
            });
        }
        }
    );
</script>
</body>
</html>
