<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/dt-1.10.20/datatables.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
          integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <style>
        .imgProfilo {
            height: 150px;
            width: 150px;
        }

        .riga {
            border: rgba(189, 183, 193, 0.2) 1px solid;
            margin-bottom: 25px;
            margin-top: 25px;
        }

        .fs-150 {
            font-size: 150px;
        }
    </style>
    <script type="text/javascript"
            src="https://cdn.datatables.net/v/bs4/jq-3.3.1/dt-1.10.20/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
</head>
<body>
<div id="login-wrap" class="row px-2">
    <div class="col">
        <label for="email">Inserisci email</label><input id="email" type="email">
    </div>
    <div class="col">
        <label for="password">Inserisci password</label><input id="password" type="password">
    </div>
    <div class="col align-self-center">
        <button id="login" class="btn btn-info btn-block">Login</button>
    </div>
</div>
<script>
    $(document).ready(function () {
        let XAuth = '';
        let user = {};
        let $loginWrap;
        let $login = $("#login");

        $login.click(function () {
            runLogin();
        });

        function profiloStudentPresentation(data) {
            const ruoles = "Studente";
            let studyGrade = "Non disponibile";
            let dataNascita = new Date(data.birthday).toLocaleDateString();
            $loginWrap.after("<div id='profilo-wrap' style='display: none;'></div>");
            let $profilowrap = $("#profilo-wrap");

            $profilowrap.append("<div class='riga'></div><div class='row'></div>");
            let $profilowrapRow = $("#profilo-wrap div.row");

            $profilowrapRow.append("<div class='col-auto align-self-center pl-3'></div>");
            let $profilowrapRowColAutoAlign = $("#profilo-wrap div.row div.col-auto.align-self-center");

            if (data.image !== null && data.image !== undefined && data.image !== ' ') {
                $profilowrapRowColAutoAlign.append("<img class='imgProfilo rounded-circle' src=\"" + data.image + "\" alt='img profilo'>");
            } else {
                $profilowrapRowColAutoAlign.append("<i class='fas fa-user-circle text-primary fs-150'></i>")
            }
            $profilowrapRow.append("<div class='col-auto row pr-5'></div>");
            if (data.studyGrade !== null && data.studyGrade !== undefined) {
                studyGrade = data.studyGrade;
            }
            let $profilowarpRowColAutoRowPr5 = $("#profilo-wrap div.row div.col-auto.row.pr-5");

            $profilowarpRowColAutoRowPr5.append("<div class='col-auto'><h3>" + data.name + " " + data.surname + "</h3><h3>" + ruoles + "</h3><h3>Nato il:</h3></div>");
            $profilowarpRowColAutoRowPr5.append("<div class='col-auto'><h3>" + data.email + "</h3><h3>" + studyGrade + "</h3><h3>" + dataNascita + "</h3></div>")
            $profilowrap.after("<div class='riga'></div><div id='bottoni-profilo' class='row px-2' style='display: none;'></div>");
            let $bottoniProfilo = $("#bottoni-profilo");

            $bottoniProfilo.append("<div class='col'><button id='moficaUtente' class='btn btn-info btn-block'>Modifica Utente</button></div>" +
                "<div class='col'><button id='Lista-Chat' class='btn btn-success btn-block'>Visualizza chat disponibili</button>\n" +
                "</div><div class='col'><button id='logOut' class='btn btn-danger btn-block'>Logout</button></div>");

            $("#logOut").click(function () {
                logOut();
            });

            $loginWrap.fadeOut();
            $profilowrap.fadeIn();
            $bottoniProfilo.fadeIn();
        }

        function profiloTeacherPresentation(data) {
            const ruoles = "Teacher";
            let byography = "Non disponibile";
            let dataNascitaT = new Date(data.birthday).toLocaleDateString();
            $loginWrap.after("<div id='profilo-wrap' style='display: none;'></div>");
            let $profilowrap = $("#profilo-wrap");

            $profilowrap.append("<div class='riga'></div><div class='row'></div>");
            let $profilowrapRow = $("#profilo-wrap div.row");

            $profilowrapRow.append("<div class='col-auto align-self-center pl-3'></div>");
            let $profilowrapRowColAutoAlign = $("#profilo-wrap div.row div.col-auto.align-self-center");

            if (data.image !== null && data.image !== undefined && data.image !== ' ') {
                $profilowrapRowColAutoAlign.append("<img class='imgProfilo rounded-circle' src=\"" + data.image + "\" alt='img profilo'>");
            } else {
                $profilowrapRowColAutoAlign.append("<i class='fas fa-user-circle text-primary fs-150'></i>")
            }
            $profilowrapRow.append("<div class='col-auto row pr-5'></div>");
            if (data.byography !== null && data.byography !== undefined) {
                byography = data.byography;
            }
            let $profilowarpRowColAutoRowPr5 = $("#profilo-wrap div.row div.col-auto.row.pr-5");

            $profilowarpRowColAutoRowPr5.append("<div class='col-auto'><h3>" + data.name + " " + data.surname + "</h3><h3>" + ruoles + "</h3><h3>Nato il:</h3></div>");
            $profilowarpRowColAutoRowPr5.append("<div class='col-auto'><h3>" + data.email + "</h3><h3>&nbsp;</h3><h3>" + dataNascitaT + "</h3></div>");
            $profilowrap.after("<div class='riga'></div><div id='bottoni-profilo' class='row px-2' style='display: none;'></div>");
            let $bottoniProfilo = $("#bottoni-profilo");

            $bottoniProfilo.append("<div class='col'><button id='moficaUtente' class='btn btn-info btn-block'>Modifica Utente</button></div>" +
                "<div class='col'><button id='Lista-Chat' class='btn btn-success btn-block'>Visualizza chat disponibili</button>\n" +
                "</div><div class='col'><button id='logOut' class='btn btn-danger btn-block'>Logout</button></div>");

            $("#logOut").click(function () {
                logOut();
            });

            $loginWrap.fadeOut();
            $profilowrap.fadeIn();
            $bottoniProfilo.fadeIn();
        }

        async function login(email, password) {
            await $.ajax({
                contentType: "application/json",
                dataType: "json",
                url: "http://localhost:8080/api/auth",
                method: "POST",
                data: JSON.stringify({
                    "username": email,
                    "password": password
                }),
                success: function (data, textStatus, request) {
                    console.log(data);
                    console.log(textStatus);
                    console.log(request.getAllResponseHeaders());
                    user = data;
                    XAuth = request.getResponseHeader("X-Auth");
                },
            });
        }

        function runLogin() {
            const email = $("#email").val();
            const passowd = $("#password").val();
            console.log(email);
            console.log(passowd);
            if (email !== null && email !== undefined && email !== " " && email !== "" && passowd !== null && passowd !== undefined && passowd !== " " && passowd !== "") {
                login(email, passowd).then(() => {
                    $("input").val("");
                    $loginWrap = $("#login-wrap");
                    if (user.roles === 1) {
                        profiloStudentPresentation(user);
                    } else {
                        profiloTeacherPresentation(user);
                    }
                });
            }
        }

        async function logOut() {
            console.log("cliccato");
            user = {};
            XAuth = "";
            await $("body").children().fadeOut();
            $("body").children().remove();
            $("body").append($loginWrap);
            $loginWrap.fadeIn();
            $login.click(function () {
                runLogin();
            });
        }
    });
</script>
</body>
</html>
